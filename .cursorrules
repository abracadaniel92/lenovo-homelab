# Cursor Rules & Governance (AI Constitution)

This file defines the strict operating rules for this repository. FAILURE TO FOLLOW THESE RULES will result in service outages.

## üî¥ CRITICAL: Networking & Ingress (NEVER CHANGE)
1.  **Cloudflare Tunnel Binding**:
    *   **RULE**: In `~/.cloudflared/config.yml` (and repo copies), the `service` URL must ALWAYS be `http://localhost:8080`.
    *   **PROHIBITED**: NEVER use `127.0.0.1:8080`. This causes intermittent connection failures due to the `network_mode: host` and `systemd-resolved` interactions on this specific machine.
    *   **WHY**: The tunnel runs in Docker with host networking; `localhost` resolves reliably via `/etc/hosts`, while `127.0.0.1` has caused loopback routing issues.

2.  **Caddy Reverse Proxy**:
    *   **Source of Truth**: `docker/caddy/Caddyfile` is the ONLY valid configuration file. Ignore `site/` or `config/` subdirectories.
    *   **Standard Block**: When adding a new service, use this EXACT template:
        ```caddyfile
        handle @subdomain {
            reverse_proxy http://172.17.0.1:PORT
        }
        ```
    *   **NO Header Overrides**: DO NOT add `header_up Host {host}` or `X-Forwarded-*` unless explicitly required by the documentation for *reverse proxies* (not just general use).
    *   **Media Servers**: For Jellyfin/Plex/Navidrome, explicit `encode gzip` is PROHIBITED as it breaks mobile streaming.

## üõ°Ô∏è Operational Safety
3.  **Governance**:
    *   **NEVER** modify existing, working Caddyfile blocks while troubleshooting a new service.
    *   **ALWAYS** check `usefull files/TROUBLESHOOTING_LOG.md` before suggesting a fix.
    *   **ALWAYS** run `scripts/verify-services.sh` after any network change.

4.  **Service Addition Protocol**:
    *   Read `SERVICE_ADDITION_CHECKLIST.md` before generating config.
    *   Check for port conflicts (`sudo ss -tulpn`) before assigning a port.

## üìù Documentation
5.  **Logging**: All major changes and troubleshooting steps must be logged in `usefull files/TROUBLESHOOTING_LOG.md`.

## üöß Scope Enforcement (The "Surgical" Rule)
6.  **Isolation**:
    *   When troubleshooting "Service A", you are **FORBIDDEN** from editing the configuration of "Service B".
    *   If a global change seems necessary (e.g., global Caddy settings), you must **STOP and ASK** the user for explicit permission first.
    *   **Files**: changes should primarily be limited to `docker/<service>/` and the specific block in `Caddyfile`. DO NOT touch `enhanced-health-check.sh` or `config.yml` unless you are specifically fixing a regression in those files.
