#!/bin/bash
###############################################################################
# Setup Uptime Kuma Monitor for Cloudflared with Slack Notifications
# This script provides instructions and attempts to configure via API if possible
###############################################################################

UPTIME_KUMA_URL="http://localhost:3001"
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"

echo "=========================================="
echo "Setting up Cloudflared monitor in Uptime Kuma"
echo "=========================================="
echo ""

# Check if Uptime Kuma is accessible
if ! curl -s "$UPTIME_KUMA_URL/api/status" > /dev/null 2>&1; then
    echo "❌ ERROR: Cannot connect to Uptime Kuma at $UPTIME_KUMA_URL"
    echo "   Make sure Uptime Kuma is running: docker ps | grep uptime-kuma"
    exit 1
fi

echo "✓ Uptime Kuma is accessible at $UPTIME_KUMA_URL"
echo ""

echo "=========================================="
echo "Step-by-Step Setup Instructions"
echo "=========================================="
echo ""
echo "1. Open Uptime Kuma in your browser:"
echo "   → $UPTIME_KUMA_URL"
echo ""
echo "2. Log in (if not already logged in)"
echo ""
echo "3. Click 'Add New Monitor' (or the '+' button)"
echo ""
echo "4. Configure Monitor Settings:"
echo "   ┌─────────────────────────────────────┐"
echo "   │ Monitor Type: HTTP(s) - Keyword     │"
echo "   │ Friendly Name: Cloudflared Tunnel  │"
echo "   │ URL: https://gmojsoski.com         │"
echo "   │ Interval: 60 seconds               │"
echo "   │ Retry Interval: 30 seconds        │"
echo "   │ Max Retries: 3                     │"
echo "   │ Keyword: gmojsoski                 │"
echo "   │ Expected Status Code: 200          │"
echo "   └─────────────────────────────────────┘"
echo ""
echo "5. Configure Slack Notification:"
echo ""
echo "   a. Scroll down to the 'Notify' section"
echo ""
echo "   b. Check if you already have a Slack notification:"
echo "      → Go to Settings → Notifications"
echo "      → Look for an existing Slack notification"
echo ""
echo "   c. If you DON'T have a Slack notification yet:"
echo "      → Click 'Setup Notification' or go to Settings → Notifications"
echo "      → Click 'Add Notification'"
echo "      → Select 'Slack'"
echo "      → Configure:"
echo "         • Friendly Name: Slack Alerts"
echo "         • Webhook URL: $SLACK_WEBHOOK_URL"
echo "         • Channel: (leave empty for default)"
echo "         • Username: Uptime Kuma (optional)"
echo "      → Click 'Test' to verify it works"
echo "      → Click 'Save'"
echo ""
echo "   d. Back in the monitor configuration:"
echo "      → In the 'Notify' section, select your Slack notification"
echo "      → Enable these checkboxes:"
echo "         ✓ Notify When Down"
echo "         ✓ Notify When Up (recommended)"
echo ""
echo "6. Click 'Save' at the bottom"
echo ""
echo "=========================================="
echo "Verification"
echo "=========================================="
echo ""
echo "After saving, you should see:"
echo "  ✓ A new monitor called 'Cloudflared Tunnel'"
echo "  ✓ It should show as 'UP' (green)"
echo ""
echo "To test the notification:"
echo "  1. In Uptime Kuma, click on your new monitor"
echo "  2. Click the 'Test' button"
echo "  3. You should receive a Slack notification"
echo ""
echo "Or test by stopping cloudflared:"
echo "  sudo systemctl stop cloudflared.service"
echo "  # Wait 1-2 minutes for notification"
echo "  sudo systemctl start cloudflared.service"
echo ""
echo "=========================================="
echo "Quick Reference"
echo "=========================================="
echo ""
echo "Monitor URL: https://gmojsoski.com"
echo "Slack Webhook: $SLACK_WEBHOOK_URL"
echo "Uptime Kuma: $UPTIME_KUMA_URL"
echo ""
echo "Done! Your Cloudflared monitor is now set up with Slack notifications."
echo ""
