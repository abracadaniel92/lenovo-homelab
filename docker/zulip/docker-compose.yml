services:
  database:
    image: zulip/zulip-postgresql:14
    container_name: zulip-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: zulip
      POSTGRES_USER: zulip
      POSTGRES_PASSWORD: zulip
    volumes:
      - zulip-database:/var/lib/postgresql/data
    networks:
      - zulip-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zulip -d zulip"]
      interval: 30s
      timeout: 10s
      retries: 3

  memcached:
    image: memcached:alpine
    container_name: zulip-memcached
    restart: unless-stopped
    command: memcached -m 256
    networks:
      - zulip-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 30s
      timeout: 10s
      retries: 3

  rabbitmq:
    image: rabbitmq:3-alpine
    container_name: zulip-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: zulip
      RABBITMQ_DEFAULT_PASS: zulip
    volumes:
      - zulip-rabbitmq:/var/lib/rabbitmq
    networks:
      - zulip-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: zulip-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - zulip-redis:/data
    networks:
      - zulip-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  zulip-init-certificates:
    image: alpine:latest
    container_name: zulip-init-certificates
    restart: "no"
    command:
      - sh
      - -c
      - |
        apk add --no-cache openssl
        mkdir -p /data
        if [ ! -f /data/zulip.key ]; then
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /data/zulip.key \
            -out /data/zulip.crt \
            -subj "/CN=zulip.gmojsoski.com/O=Zulip/C=US"
          chmod 600 /data/zulip.key
          chmod 644 /data/zulip.crt
          echo "✅ Self-signed certificates generated at /data/"
        else
          echo "ℹ️  Certificates already exist at /data/"
        fi
    volumes:
      - zulip-data:/data
    networks:
      - zulip-net

  zulip:
    image: zulip/docker-zulip:latest
    container_name: zulip
    restart: unless-stopped
    ports:
      - "8070:80"
    environment:
      # Database
      DB_HOST: database
      DB_HOST_PORT: 5432
      POSTGRES_USER: zulip
      POSTGRES_PASSWORD: zulip
      POSTGRES_DB: zulip
      
      # Secrets (CHANGE THESE in production!)
      SECRET_KEY: change-me-to-a-secret-key-minimum-32-characters-long
      ZULIP_SECRETS_DB_PASSWORD: zulip
      SECRETS_postgres_password: zulip
      
      # Services
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: 11211
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # Server configuration
      SETTING_EXTERNAL_HOST: zulip.gmojsoski.com
      SETTING_RABBITMQ_HOST: rabbitmq
      
      # SSL Configuration (self-signed for internal use - Caddy handles external SSL)
      SSL_CERTIFICATE_GENERATION: self-signed
      DISABLE_HTTPS: "True"
      
      # Email (console backend for initial setup)
      SETTING_EMAIL_BACKEND: console.EmailBackend
      
    volumes:
      - zulip-data:/data
      - zulip-uploads:/var/lib/zulip/uploads
      - zulip-logs:/var/log/zulip
    depends_on:
      database:
        condition: service_healthy
      memcached:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      zulip-init-certificates:
        condition: service_completed_successfully
    networks:
      - zulip-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  zulip-data:
  zulip-database:
  zulip-uploads:
  zulip-logs:
  zulip-rabbitmq:
  zulip-redis:

networks:
  zulip-net:
    driver: bridge
