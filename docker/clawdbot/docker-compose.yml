services:
  clawdbot-gateway:
    build:
      context: /home/goce/Desktop/Cursor projects/moltbot
      dockerfile: Dockerfile.clawdbot
    container_name: clawdbot-gateway
    restart: unless-stopped
    profiles:
      - productivity
      - all
    environment:
      HOME: /home/node
      TERM: xterm-256color
      NODE_ENV: production
      TMPDIR: /home/node/clawd/tmp
      # Gateway configuration
      CLAWDBOT_GATEWAY_TOKEN: ${CLAWDBOT_GATEWAY_TOKEN}
      CLAWDBOT_GATEWAY_BIND: ${CLAWDBOT_GATEWAY_BIND:-loopback}
      CLAWDBOT_GATEWAY_PORT: ${CLAWDBOT_GATEWAY_PORT:-18789}
      # Mattermost environment variables (for default account)
      MATTERMOST_BOT_TOKEN: ${MATTERMOST_BOT_TOKEN:-}
      MATTERMOST_URL: ${MATTERMOST_URL:-http://mattermost:8065}
      # Optional: Claude API keys (if using cloud models)
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
      # Google Gemini API key
      GEMINI_API_KEY: ${GEMINI_API_KEY:-AIzaSyAYBg8GN2pN4nurkigskosHGc6BrMQjR5w}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-AIzaSyAYBg8GN2pN4nurkigskosHGc6BrMQjR5w}
    volumes:
      - /home/goce/docker-data/clawdbot/config:/home/node/.clawdbot
      - /home/goce/docker-data/clawdbot/workspace:/home/node/clawd
    # Security: Bind to loopback only (not exposed externally)
    # Port mapping only for localhost access if needed
    ports:
      - "127.0.0.1:${CLAWDBOT_GATEWAY_PORT:-18789}:18789"
    # Security: Resource limits to prevent resource exhaustion
    mem_limit: 2g
    memswap_limit: 2g
    cpus: '1.0'
    # Security: Network isolation - connect to Mattermost network
    networks:
      - mattermost-net
    # Security: Run as non-root user (already set in Dockerfile)
    user: node
    # Security: Read-only root filesystem (except mounted volumes)
    # Note: tmpfs for /tmp needed for logging/temp files
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Security: Drop all capabilities
    cap_drop:
      - ALL
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
    # Health check (token passed via environment)
    healthcheck:
      test: ["CMD-SHELL", "node dist/index.js health --token \"$$CLAWDBOT_GATEWAY_TOKEN\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${CLAWDBOT_GATEWAY_BIND:-loopback}",
        "--port",
        "${CLAWDBOT_GATEWAY_PORT:-18789}"
      ]
    init: true

networks:
  mattermost-net:
    external: true
    name: mattermost_mattermost-net

