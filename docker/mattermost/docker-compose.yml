services:
  database:
    image: postgres:15-alpine
    container_name: mattermost-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: mattermost
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmuser_password
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - mattermost-database:/var/lib/postgresql/data
    networks:
      - mattermost-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3

  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: mattermost
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    ports:
      - "8066:8065"
    environment:
      # Database
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mmuser_password@database:5432/mattermost?sslmode=disable&connect_timeout=10
      
      # Server configuration
      MM_SERVICESETTINGS_SITEURL: https://mattermost.gmojsoski.com
      MM_SERVICESETTINGS_LISTENADDRESS: ":8065"
      MM_SERVICESETTINGS_ENABLELOCALMODE: "false"
      
      # Email (console backend for initial setup)
      MM_EMAILSETTINGS_ENABLESIGNUPWITHEMAIL: "true"
      MM_EMAILSETTINGS_ENABLESIGNINWITHEMAIL: "true"
      MM_EMAILSETTINGS_ENABLESMTPAUTH: "false"
      
      # Push Notifications (TPNS - Test Push Notification Service for non-commercial self-hosted)
      # Note: TPNS is free but not recommended for production (no SLA)
      # For production, consider upgrading to Enterprise/Professional for HPNS
      MM_EMAILSETTINGS_SENDPUSHNOTIFICATIONS: "true"
      MM_EMAILSETTINGS_PUSHNOTIFICATIONSERVER: "https://push-test.mattermost.com"
      
      # Security
      MM_SERVICESETTINGS_ENABLEOPENSERVER: "true"
      
      # File storage
      MM_FILESETTINGS_MAXFILESIZE: 52428800  # 50MB
      
      # Plugins
      MM_PLUGINSETTINGS_ENABLEUPLOADS: "true"
      
    volumes:
      - mattermost-data:/mattermost/data
      - mattermost-config:/mattermost/config
      - mattermost-logs:/mattermost/logs
      - mattermost-plugins:/mattermost/plugins
      - mattermost-client-plugins:/mattermost/client/plugins
      - mattermost-bleve-indexes:/mattermost/bleve-indexes
    networks:
      - mattermost-net
    # Health check removed - Mattermost container doesn't have curl/wget
    # Mattermost is running fine (verified via API ping from host)
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s

volumes:
  mattermost-database:
  mattermost-data:
  mattermost-config:
  mattermost-logs:
  mattermost-plugins:
  mattermost-client-plugins:
  mattermost-bleve-indexes:

networks:
  mattermost-net:
    driver: bridge

